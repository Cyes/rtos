# 关于这个内核的想法

---

### 说两句

* 时间跨度 `2021.04.29 ~ 2021.05.31`

```
本来计划用两个月写出来一个调度内核, 两周就初见雏形了，后面两周不断推翻之前的东西，一直修修改改，有些思路实现比较复杂就没有实现，转而使用更容易理解的笨方法来实现，这牺牲了一定的系性能和优雅，胜在结构简单
在寻找更好的实现方式时才发现网上针对 Cortex-M 的OS不是一般的多，有的内核甚至提供针对一个问题提供所有的解法。
```

### 思路讲解
* 目录树

  | 名称    | 文件功能       |
  | :------ | -------------- |
  | demo    | 用于测试的例程 |
  | Drivers | STM32 HAL 库   |
  | kernel  | 内核文件       |

* `task`
  
  使用`CLZ`指令实现优先级确定，支持`0~31`优先级，需要指定32个链表，每次移动函数需要操作对应链表和更新优先级标志，支持任务返回，返回即删除


* `timer`、`queue`、`semaphore`

  使用同一个阻塞机制，可以考虑分离出来或者合并一些东西

* `dynamic_block`

  基于数组的连续性实现内存碎片的合并，每次申请内存都要从头开始找合适和大小并返回，释放只需要放回清标志位即可，性能和利用率之间的考量使用`BLOCK`大小权衡

* `mutex`

  没有使用32级函数列表，因为在优先级天花板协议下所有任务优先级相同，实现时需要小心优先级更改的处理

* `port`

  实现调度`CPU`寄存器的保存和加载，也是学到最多的地方





